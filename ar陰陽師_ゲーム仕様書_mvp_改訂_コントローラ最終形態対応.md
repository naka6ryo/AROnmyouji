# 1．目的

本書は，仮称AR陰陽師のゲーム側実装仕様を定義する．本書を参照すれば，Web実装で動作するMVP版ゲームを再現可能な粒度で設計，実装，デモ運用できることを目的とする．

# 2．スコープ

## 2．1 対象

1．iPhone上のWeb BLEブラウザで動作するWebゲーム本体
2．疑似AR表示，カメラ映像背景＋3D描画の重畳
3．BLEでグローブ型コントローラへ接続し，センサデータを受信してゲーム入力とする
4．斬撃，術1札，簡易的な術2強化モードを含む
5．敵1種類のウェーブ制
6．ゲームイベントに応じてコントローラへ触覚コマンドを送信する
7．デバッグHUDとログ機構

## 2．2 非対象

1．本物AR，平面検出，空間固定
2．マルチプレイ，同期
3．アカウント，ランキング，永続保存
4．高度な物理演算，遮蔽，環境オクルージョン

# 3．前提条件と制約

1．デモ機はiPhoneのみとする．
2．実行はBluefy等のWeb BLE対応ブラウザ上とする．
3．HTTPS配信を必須とする．カメラ使用，センサ使用のためセキュアコンテキストを前提とする．
4．コントローラはBLE Peripheralであり，ゲームはBLE Centralとして接続する．
5．コントローラは振り強度に応じた触覚フィードバックを自律生成する．ゲーム側は原則として連続触覚制御を行わず，離散イベント触覚のみ送信する．
6．センサ上りデータは60Hz程度を目標とする．欠落は起こり得るため，ゲームは欠落耐性を持つ．
7．開発環境はWindowsを想定する．iPhone実機の深いWebViewデバッグが難しいため，ゲーム内デバッグHUDとリモートログを必須とする．

# 4．用語

1．端末，iPhone
2．ブラウザ，Bluefy等
3．グローブ，右手装着コントローラ
4．疑似AR，カメラ映像を背景に3DとUIを重畳し，端末姿勢で視点を回す方式
5．G，グローバル座標系
6．フレーム，コントローラから受信する1サンプルのセンサデータ

# 5．コントローラ通信仕様，ゲーム側で必要な部分

## 5．1 UUID

以下を確定値として使用する．

- SERVICE_UUID，12345678-1234-1234-1234-123456789abc
- SENSOR_CHAR_UUID，12345678-1234-1234-1234-123456789abd
- HAPTIC_CHAR_UUID，12345678-1234-1234-1234-123456789abe

## 5．2 上りフレーム，15バイト固定長

1．header，0x53
2．seq，0から255循環
3．ax，ay，az，int16，固定小数点×100，単位はg換算，座標系はグローバルG
4．pitch，yaw，roll，int16，固定小数点×10，単位は度
5．flags，uint8，予約

復元式

- ax_g ＝ int16_ax／100
- pitch_deg ＝ int16_pitch／10

## 5．3 下り触覚コマンド，2バイト

1．strength，0から255
2．duration，10ms単位，0から255，最大2550ms

## 5．4 触覚責務

1．振り強度触覚はコントローラが自律生成する．
2．ゲーム側触覚コマンド実行中は，コントローラの自律振動が抑制され得る．
3．よってゲーム側触覚は短パルス中心とし，送信頻度を制限する．

# 6．権限と起動導線

## 6．1 必須権限

1．カメラ権限，背景映像用
2．モーション権限，端末姿勢取得用
3．BLE権限，コントローラ接続用

## 6．2 起動フロー，画面遷移

状態機械として定義する．
1．S0，Splash
2．S1，Permission
3．S2，BleConnect
4．S3，Calibrate
5．S4，Gameplay
6．S5，Result

遷移

- S0→S1，開始ボタン押下
- S1→S2，カメラとモーション許可が成功
- S2→S3，BLE接続成功，Notify購読開始
- S3→S4，キャリブレーション確定
- S4→S5，終了条件達成
- 任意→S2，再接続
- 任意→S3，再キャリブレーション

## 6．3 UI要件

1．開始ボタンは必ずユーザ操作起点として実装する．
2．許可失敗時は，何が拒否されたかを明示し，再試行ボタンを出す．
3．BLE接続はユーザ操作起点で開始する．

# 7．疑似AR表示仕様

## 7．1 カメラ背景

1．getUserMediaで背面カメラを取得し，全画面に表示する．
2．アスペクト比は端末に合わせ，トリミングを許容する．

## 7．2 3D重畳

1．3D描画はThree.js等で行う．
2．カメラ背景はDOMのvideoとして背面，3Dキャンバスは前面に重畳する．
3．UIはHTMLで最前面に重畳してよい．

## 7．3 視点制御

1．端末姿勢から視線方向ベクトルv_viewを求める．
2．ゲーム世界はプレイヤー中心であり，v_viewにより画面中心レティクルが向く方向を定義する．
3．FOVは初期値60度とし，端末や演出により調整可能とする．

# 8．ワールドと座標系

## 8．1 ワールドモデル

1．世界原点はプレイヤー位置とする．
2．敵は球面座標で保持する．

- 方位角azim，仰角elev，距離r
  3．敵方向ベクトルv_enemyは，azim，elevから算出する．

## 8．2 命中判定の基本

1．角度差θ ＝ acos(clamp(dot(v_view，v_enemy)，-1，1))
2．θが閾値未満なら視線命中とする．
3．斬撃，札など行為ごとに閾値を変える．

# 9．ゲームループ

## 9．1 更新周期

1．描画はrequestAnimationFrameで更新する．
2．入力はBLE通知受信で更新する．
3．ゲーム内部のシミュレーションΔtは固定刻みを推奨する．例，1／60秒

## 9．2 入力欠落対策

1．BLEフレームに欠落があってもゲームループを停止しない．
2．直近フレームを保持し，欠落時は直近値をホールドする．
3．seq差分で欠落数を計測し，デバッグHUDに表示する．

# 10．入力解釈

## 10．1 基本量

1．加速度ベクトルa ＝ (ax_g，ay_g，az_g)
2．加速度大きさa_mag ＝ sqrt(ax_g^2＋ay_g^2＋az_g^2)
3．姿勢角pyr ＝ (pitch_deg，yaw_deg，roll_deg)

注意

- aはグローバルG座標である．端末座標と一致する保証はない．ゲーム側の斬撃方向推定には姿勢を使用し，aは強度と発火判定に使用する．

## 10．2 キャリブレーション

目的

- グローブ姿勢から得る攻撃方向を，端末の視線基準に近付ける．

手順
1．ユーザに，端末正面に向けてグローブも正面へ構える姿勢を取らせる．
2．Calibrate確定で，その時点の(pitch，yaw，roll)を基準pyr0として保存する．
3．以後，相対角pyr_rel ＝ unwrap(pyr − pyr0)を算出する．
4．pyr_relから攻撃方向ベクトルv_attackを生成する．

実装注記

- unwrapは角度ラップを跨ぐ差分を連続化する関数である．

## 10．3 斬撃検出

状態機械

- Idle
- SwingArmed
- SwingActive
- Cooldown

特徴量

- a_mag
- da_mag ＝ a_mag − a_mag_prev

閾値，初期値

- A_START ＝ 0．25g
- A_END ＝ 0．18g
- DA_START ＝ 0．08g
- T_MIN ＝ 60ms
- T_COOLDOWN ＝ 220ms
- A_MAX ＝ 0．60g，強度正規化上限

遷移
1．Idle→SwingActive，a_mag≥A_START かつ da_mag≥DA_START かつ cooldown経過
2．SwingActive→Cooldown，a_mag≤A_END かつ継続時間≥T_MIN
3．Cooldown→Idle，T_COOLDOWN経過

斬撃強度

- I_swing ＝ clamp((a_mag − A_START)／(A_MAX − A_START)，0，1)

斬撃方向

- v_attackはpyr_relから算出する前方ベクトル
- MVPではv_attackの詳細算出は，yaw，pitchに基づく球面ベクトルでよい

## 10．4 術1，札，円ジェスチャ

入力窓

- 0．6秒から1．5秒のリングバッファ

使用信号

- yaw_degとpitch_degの時系列

特徴量
1．軌跡長L，連続差分の合計
2．閉曲線度C，開始点と終了点の距離d_se
3．回転量R，符号付き角速度の累積

成立条件，初期値

- L ≥ 120deg
- d_se ≤ 25deg
- |R| ≥ 260deg
- 発動クールダウン 700ms

発動方向

- 札はv_view方向へ飛ばす．MVPでは視線中心固定とする．

## 10．5 術2，強化モード，簡易版

MVPでは五芒星の厳密認識は行わず，隠しコマンドとして扱う．

成立条件，初期値

- 1．2秒以内に斬撃が3回成立
- かつ，各斬撃のI_swingの平均が0．5以上

効果

- 10秒間，命中判定角度閾値を緩和し，ダメージを1増加させる

# 11．戦闘仕様

## 11．1 敵仕様，EnemyA

パラメータ

- HP ＝ 2
- 距離r ＝ 3．5m相当，表示単位は任意
- 接近速度 ＝ 0．45r／秒
- 被弾距離 ＝ 0．9r

スポーン

- 初期は1体
- 撃破ごとにスポーン間隔を短縮

スポーン間隔

- 初期 2．2秒
- 最小 0．9秒

## 11．2 命中判定

基本角度閾値

- 斬撃命中角θ_swing ＝ 10deg
- 札命中角θ_ofuda ＝ 6deg

斬撃命中
1．SwingActive終了時点でv_attackを確定
2．v_attackと各敵v_enemyの角度差がθ_swing未満なら命中
3．命中した敵にダメージDを与える

札命中
1．札はv_view方向へ進み，寿命は800ms
2．寿命中，v_viewと敵方向の角度差がθ_ofuda未満で命中とする

ダメージ

- 通常D＝1
- 強化中D＝2

## 11．3 被弾

1．敵距離が被弾距離未満に到達した時点で被弾扱い
2．被弾でPlayerHPを1減少
3．被弾後，敵は消滅し，次スポーンへ

プレイヤーHP

- 初期HP ＝ 5

終了条件

- HPが0でGameOver
- または制限時間2分でClear

# 12．触覚仕様，ゲーム側

## 12．1 原則

1．振り触覚はコントローラが自律生成する．ゲーム側はそれを上書きしない．
2．ゲーム側触覚はイベント通知のみとし，短いパルス中心とする．
3．送信頻度を制限し，BLEと体感の安定性を優先する．

## 12．2 触覚イベント定義

1．斬撃命中

- 1パルス，strength＝200，duration＝6
- 最小間隔T_HIT_MIN＝150ms

2．クリティカル命中

- 条件，I_swing≥0．85 かつ命中
- 2パルス，(200，6)を40ms空けて2回

3．被弾

- 1パルス，strength＝255，duration＝12

4．術成立

- 1パルス，strength＝180，duration＝15

5．術失敗

- 1パルス，strength＝80，duration＝10

6．強化開始

- 2パルス，(220，10)を80ms空けて2回

## 12．3 優先度

高→低
1．被弾
2．術成立，強化開始
3．クリティカル
4．斬撃命中
5．術失敗

優先度が高いイベントが来た場合，低いイベントの未送信分は破棄してよい．

## 12．4 レート制限

1．全触覚送信は最大10コマンド／秒
2．T_HIT_MINを超えない命中は集約して1回にする

# 13．UI仕様

## 13．1 通常HUD

1．中央レティクル
2．HP表示
3．撃破数
4．強化残り時間
5．BLE接続アイコン

## 13．2 画面

1．Permission画面，開始，権限状態
2．BleConnect画面，接続ボタン，接続状態
3．Calibrate画面，手順表示，確定ボタン
4．Gameplay画面，HUD，デバッグ切替
5．Result画面，結果，リトライ，再接続，再キャリブレーション

# 14．デバッグ仕様，Windows開発前提で必須

## 14．1 デバッグHUD表示切替

1．3秒長押しで表示切替
2．表示は半透明パネル

## 14．2 表示項目

1．BLE接続状態
2．受信Hz，移動平均
3．seq欠落数，欠落率
4．フレーム間隔のばらつき
5．a_mag，pitch，yaw，roll
6．斬撃状態，クールダウン残
7．円判定の中間量，成立可否
8．直近触覚イベントと送信回数
9．直近エラー文字列

## 14．3 ログ機構

1．リングバッファにイベントログを保持する
2．ログは画面上でスクロール表示できる
3．任意で，LAN上のWebSocketへログを送信できる

# 15．実装アーキテクチャ

## 15．1 モジュール

1．AppState

- 状態機械S0からS5を管理

2．BleControllerAdapter

- 接続，Service取得，Characteristic取得
- Notify購読
- Haptics Write送信

3．SensorFrameParser

- 15バイトパース，スケール復元
- seq欠落計測

4．MotionInterpreter

- キャリブレーション
- 斬撃状態機械
- 円ジェスチャ判定
- 強化判定

5．GameWorld

- 敵配列管理
- スポーン制御
- 更新Δt

6．CombatSystem

- 命中判定
- ダメージ適用
- 触覚イベント生成

7．Renderer

- カメラ背景
- 3D描画
- UI同期

8．DebugOverlay

- HUDとログ

## 15．2 データフロー

1．BLE Notify → SensorFrameParser → MotionInterpreter
2．MotionInterpreter → CombatSystem → GameWorld更新
3．CombatSystem → HapticsEmitter → BLE Write
4．全系統 → DebugOverlay

# 16．配布と運用

## 16．1 配布

1．HTTPSでホストする
2．デモ端末にBluefyをインストールし，URLをブックマークしておく

## 16．2 端末設定

1．画面自動ロックを長くする
2．低電力モードを切る
3．通知を切る
4．権限を事前に通す

# 17．テスト計画

## 17．1 通信

1．接続，切断，再接続を10回連続
2．平均受信Hzが55以上
3．欠落率が5％未満

## 17．2 入力

1．斬撃が意図した動作で発火
2．クールダウン中に二重発火しない
3．円が成立しやすく，誤発動が致命的に多くない

## 17．3 触覚

1．振り触覚はコントローラ自律で発生する
2．命中，術成立，被弾で追加触覚が発生し区別できる
3．触覚多発時でもBLE切断しにくい

## 17．4 演出

1．敵が360度に出現し，端末を回して探索できる
2．HUDが読みやすい

# 18．受け入れ基準

1．iPhone＋Bluefyで起動できる．
2．カメラ背景＋3D敵が表示される．
3．BLE接続ができ，Notifyを継続受信できる．
4．斬撃で敵を撃破できる．
5．振り触覚がコントローラ自律で発生する．
6．命中，術成立，被弾のイベント触覚が送信される．
7．デバッグHUDで受信Hzと欠落率が確認できる．

# 19．パラメータ一覧，初期値

1．A_START 0．25g
2．A_END 0．18g
3．DA_START 0．08g
4．T_MIN 60ms
5．T_COOLDOWN 220ms
6．A_MAX 0．60g
7．θ_swing 10deg
8．θ_ofuda 6deg
9．HP 5
10．EnemyHP 2
11．スポーン間隔 2．2秒から0．9秒

# 20．未決事項

1．コントローラ姿勢からv_attackを生成する詳細定義，yaw，pitchの対応方向，符号
2．端末姿勢からv_viewを生成する実装詳細と座標整合
3．円判定の閾値調整，デモ機で実測して確定
4．強化モードの演出詳細
