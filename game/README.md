# AR陰陽師 - MVP版

## 概要

AR陰陽師は、iPhone上のWeb BLEブラウザで動作する疑似ARゲームです。グローブ型コントローラからBLE経由でセンサーデータを受信し、斬撃や術のジェスチャを認識して敵と戦います。

## 主な機能

- **疑似AR表示**: カメラ映像背景 + Three.js 3D描画の重畳
- **BLE通信**: グローブコントローラとの接続、センサーデータ受信、触覚フィードバック送信
- **ジェスチャ認識**:
  - 斬撃検出（加速度ベース）
  - 円ジェスチャ認識（札発射）
  - 強化モード発動（連続斬撃）
- **ゲームプレイ**:
  - 敵のスポーンとウェーブ制
  - 命中判定（視線ベース）
  - HP管理、撃破数カウント
  - 制限時間2分
- **デバッグHUD**:
  - BLE接続状態
  - 受信Hz、欠落率
  - センサー値、ジェスチャ状態
  - ログ表示

## プロジェクト構造

```
game/
├── index.html              # メインHTMLファイル
├── css/
│   └── style.css          # スタイルシート
└── js/
    ├── main.js            # メインエントリーポイント
    ├── AppState.js        # 状態機械管理（S0-S5）
    ├── BleControllerAdapter.js  # BLE通信
    ├── SensorFrameParser.js     # センサーデータパース
    ├── MotionInterpreter.js     # ジェスチャ認識
    ├── GameWorld.js       # ゲーム世界管理
    ├── CombatSystem.js    # 戦闘システム
    ├── Renderer.js        # Three.js描画
    └── DebugOverlay.js    # デバッグ表示
```

## 技術仕様

### BLE通信

- **Service UUID**: `12345678-1234-1234-1234-123456789abc`
- **Sensor Characteristic UUID**: `12345678-1234-1234-1234-123456789abd`
- **Haptic Characteristic UUID**: `12345678-1234-1234-1234-123456789abe`

### センサーフレーム（15バイト）

| バイト | 内容           | 形式            |
| ------ | -------------- | --------------- |
| 0      | ヘッダー       | 0x53固定        |
| 1      | シーケンス番号 | 0-255循環       |
| 2-3    | ax             | int16 × 100 (g) |
| 4-5    | ay             | int16 × 100 (g) |
| 6-7    | az             | int16 × 100 (g) |
| 8-9    | pitch          | int16 × 10 (度) |
| 10-11  | yaw            | int16 × 10 (度) |
| 12-13  | roll           | int16 × 10 (度) |
| 14     | flags          | 予約            |

### 触覚コマンド（2バイト）

| バイト | 内容     | 範囲             |
| ------ | -------- | ---------------- |
| 0      | strength | 0-255            |
| 1      | duration | 0-255 (10ms単位) |

## 起動フロー

1. **S0: Splash** - 開始ボタン押下
2. **S1: Permission** - カメラ・モーション権限取得
3. **S2: BLE Connect** - グローブコントローラに接続
4. **S3: Calibrate** - 姿勢キャリブレーション
5. **S4: Gameplay** - ゲームプレイ
6. **S5: Result** - 結果表示

## セットアップと実行

### 必須要件

- iPhone (iOS 13以降推奨)
- Bluefyまたは他のWeb BLE対応ブラウザ
- HTTPSでホストされたWebサーバー
- グローブ型BLEコントローラ（上記仕様に対応）

### ローカル実行

1. HTTPSでゲームをホストします（セキュアコンテキストが必要）:

```powershell
# 簡易HTTPSサーバー例（証明書が必要）
# Python 3の場合
python -m http.server 8443 --bind 0.0.0.0
```

2. iPhoneでBluefyを起動し、`https://[あなたのIP]:8443/game/index.html` にアクセス

3. 画面の指示に従って権限を許可し、コントローラに接続

### デプロイ

1. `game/` ディレクトリをHTTPSサーバーにアップロード
2. iPhoneでURLにアクセス
3. ブックマークに保存（推奨）

## 操作方法

### グローブコントローラ

- **振る**: 斬撃を発動
- **円を描く**: 札を発射
- **連続で激しく振る**: 強化モード発動（10秒間）

### 端末操作

- 端末を回して視線方向を変更
- 敵は360度に出現
- レティクル（中央の+）で照準

### デバッグHUD

- 右上の「DEBUG」ボタンを3秒長押しで表示切替

## ゲームパラメータ

| パラメータ   | 初期値        | 説明             |
| ------------ | ------------- | ---------------- |
| プレイヤーHP | 5             | 初期HP           |
| 敵HP         | 2             | 敵1体のHP        |
| 制限時間     | 120秒         | ゲーム時間       |
| 斬撃閾値     | 0.25g         | 発動開始加速度   |
| 斬撃命中角   | 10度          | 命中判定角度     |
| 札命中角     | 6度           | 札の命中判定角度 |
| スポーン間隔 | 2.2秒 → 0.9秒 | 撃破ごとに短縮   |

## 設計基準

本プロジェクトは、`プログラム設計基準書.md` に基づいて設計されています：

- **単一責任の原則**: 各クラスは明確な責務を持つ
- **依存性逆転**: インターフェースを介した疎結合
- **責務分離**: ビジネスロジック、UI、通信を分離
- **可読性優先**: コードは人間が読みやすく書く

## トラブルシューティング

### BLE接続できない

- iPhoneのBluetoothがONになっているか確認
- Bluefyを使用しているか確認（SafariはWeb BLE非対応）
- コントローラの電源とペアリング状態を確認

### カメラが表示されない

- HTTPSでアクセスしているか確認
- カメラ権限を許可したか確認
- 他のアプリがカメラを使用していないか確認

### 斬撃が認識されない

- デバッグHUDで加速度値を確認
- キャリブレーションをやり直す
- 閾値を調整（MotionInterpreter.js内）

### フレーム欠落が多い

- BLE接続距離が遠すぎないか確認
- 周囲の電波干渉を確認
- コントローラのバッテリーを確認

## 開発者向け

### パラメータ調整

各クラスの初期化部分でゲームバランスを調整できます：

- `MotionInterpreter.js`: 斬撃閾値、円判定閾値
- `GameWorld.js`: 敵HP、スポーン間隔
- `CombatSystem.js`: 命中角度、ダメージ量

### 新機能追加

設計基準書に従い、以下の手順で機能を追加：

1. 責務を明確にした新規クラスを作成
2. インターフェース（コールバック）を定義
3. 既存クラスとの連携点を実装
4. main.jsで統合

## ライセンス

本プロジェクトは、`ar陰陽師_ゲーム仕様書_mvp_改訂_コントローラ最終形態対応.md` に基づいて実装されています。

## バージョン履歴

- **v1.0.0** (2026-01-17): 初版リリース
  - MVP版実装完了
  - BLE通信、ジェスチャ認識、戦闘システム実装
  - デバッグHUD実装

## お問い合わせ

質問や不具合報告は、プロジェクトのIssueトラッカーまでお願いします。
